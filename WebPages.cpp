#include "WebPages.h"
#include <EEPROM.h>
#include <WiFi.h>

// Simple CSS without special characters for AP mode compatibility
String getInlineIcons() {
  return "";
}

// Forward declaration for EEPROM function
extern String readStringFromEEPROM(int addr);

String generateMainPage(String urlMain, String ip) {
  String html = "<!DOCTYPE html>";
  html += "<html lang=\"th\">";
  html += "<head>";
  html += "<meta charset=\"UTF-8\">";
  html += "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">";
  html += "<title>Robot Arm Learning Platform</title>";
  html += "<style>";
  html += getInlineIcons();
  html += "* { margin: 0; padding: 0; box-sizing: border-box; }";
  html += "body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; min-height: 100vh; padding: 20px; }";
  html += ".container { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); max-width: 480px; margin: 0 auto; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.1); padding: 40px 32px; text-align: center; animation: slideUp 0.8s ease-out; }";
  html += "@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }";
  html += ".header { margin-bottom: 32px; }";
  html += ".robot-icon { font-size: 48px; color: #667eea; margin-bottom: 16px; animation: float 3s ease-in-out infinite; }";
  html += "@keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }";
  html += "h1 { color: #2d3748; font-size: 24px; font-weight: 700; margin-bottom: 8px; }";
  html += ".subtitle { color: #718096; font-size: 16px; font-weight: 400; }";
  html += ".section { margin-bottom: 32px; }";
  html += ".section-title { color: #4a5568; font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; }";
  html += ".section-title i { color: #667eea; }";
  html += ".menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }";
  html += ".menu-item { display: flex; align-items: center; gap: 12px; text-decoration: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; padding: 16px 20px; font-size: 15px; font-weight: 500; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }";
  html += ".menu-item::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }";
  html += ".menu-item:hover::before { left: 100%; }";
  html += ".menu-item:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }";
  html += ".menu-item:active { transform: translateY(0); }";
  html += ".menu-item i { font-size: 20px; opacity: 0.9; }";
  html += ".status-bar { background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.2); border-radius: 12px; padding: 16px; margin-top: 24px; }";
  html += ".status-item { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; color: #4a5568; font-size: 14px; }";
  html += ".status-value { font-weight: 600; color: #667eea; }";
  html += ".online-indicator { width: 8px; height: 8px; background: #48bb78; border-radius: 50%; animation: pulse 2s infinite; }";
  html += "@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }";
  html += "@media (max-width: 500px) { .container { padding: 24px 20px; margin: 10px; } .menu { grid-template-columns: 1fr; } h1 { font-size: 20px; } }";
  html += "</style>";
  html += "</head>";
  html += "<body>";
  html += "<div class='container'>";
  html += "<div class='header'>";
  html += "<div class='robot-icon'>R</div>";
  html += "<h1>Robot Arm Control Center</h1>";
  html += "<div class='subtitle'>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ç‡∏ô‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå</div>";
  html += "</div>";
  
  html += "<div class='section'>";
  html += "<div class='section-title'>‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</div>";
  html += "<div class='menu'>";
  html += "<a href='joint' class='menu-item'><span>‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Joint</span></a>";
  html += "<a href='index' class='menu-item'><span>‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° XYZ</span></a>";
  html += "<a href='gcode' class='menu-item'><span>G-code Programming</span></a>";
  html += "<a href='" + urlMain + "/blockly?ip=" + ip + "' class='menu-item'><span>Blockly Visual</span></a>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class='section'>";
  html += "<div class='section-title'>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</div>";
  html += "<div class='menu'>";
  html += "<a href='setup' class='menu-item'>üì∂<span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ WiFi</span></a>";
  html += "<a href='setuparm' class='menu-item'>üéõÔ∏è<span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏Ç‡∏ô‡∏Å‡∏•</span></a>";
  html += "<a href='ota' class='menu-item'>‚¨áÔ∏è<span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏°‡πÅ‡∏ß‡∏£‡πå</span></a>";
  html += "<a href='/api/docs' class='menu-item'>üìñ<span>API Documentation</span></a>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class='status-bar'>";
  html += "<div class='status-item'><span>üì° ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span><span class='status-value'><span class='online-indicator'></span> Online</span></div>";
  html += "<div class='status-item'><span>IP Address</span><span class='status-value'>" + ip + "</span></div>";
  html += "<div class='status-item'><span>Platform</span><span class='status-value'>ESP32</span></div>";
  html += "</div>";
  
  html += "</div>";
  html += "<script>";
  html += "document.addEventListener('DOMContentLoaded', function() {";
  html += "  const menuItems = document.querySelectorAll('.menu-item');";
  html += "  menuItems.forEach((item, index) => {";
  html += "    item.style.animationDelay = `${index * 0.1}s`;";
  html += "    item.style.animation = 'slideUp 0.6s ease-out forwards';";
  html += "  });";
  html += "});";
  html += "</script>";
  html += "</body></html>";
  return html;
}

String generateRobotControlPage(int lastTheta1, int lastTheta2, int lastTheta3, 
                               int lastGripper, int lastSpeed, int lastAcceleration,
                               double endEffectorX, double endEffectorY, double endEffectorZ) {
  String html = "<!DOCTYPE html>";
  html += "<html lang=\"en\">";
  html += "<head>";
  html += "<meta charset=\"UTF-8\">";
  html += "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">";
  html += "<title>Robot Arm Control - XYZ Mode</title>";
  html += "<style>";
  html += getInlineIcons();
  html += "* { margin: 0; padding: 0; box-sizing: border-box; }";
  html += "body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; min-height: 100vh; padding: 20px; display: flex; align-items: center; justify-content: center; }";
  html += ".container { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); max-width: 1400px; width: 100%; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.1); padding: 40px; animation: slideUp 0.8s ease-out; min-height: 85vh; display: flex; flex-direction: column; }";
  html += "@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }";
  html += ".header { text-align: center; margin-bottom: 40px; position: relative; }";
  html += ".header:before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%); border-radius: 50%; z-index: -1; }";
  html += ".header-icon { font-size: 48px; margin-bottom: 16px; filter: drop-shadow(0 4px 8px rgba(102, 126, 234, 0.3)); }";
  html += "h1 { color: #1a202c; font-size: 32px; font-weight: 800; margin-bottom: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }";
  html += ".subtitle { color: #4a5568; font-size: 16px; font-weight: 500; }";
  html += ".nav-tabs { display: flex; background: linear-gradient(145deg, #f7fafc 0%, #edf2f7 100%); border-radius: 20px; padding: 6px; margin-bottom: 32px; box-shadow: inset 0 2px 8px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.8); }";
  html += ".nav-tab { flex: 1; text-align: center; padding: 16px 24px; border-radius: 16px; text-decoration: none; color: #4a5568; font-weight: 600; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }";
  html += ".nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4), inset 0 1px 0 rgba(255,255,255,0.2); transform: translateY(-1px); }";
  html += ".nav-tab:hover:not(.active) { background: linear-gradient(145deg, #ffffff 0%, #f7fafc 100%); color: #2d3748; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }";
  html += ".header-icon { font-size: 40px; color: #667eea; margin-bottom: 12px; }";
  html += "h1 { color: #2d3748; font-size: 24px; font-weight: 700; margin-bottom: 8px; }";
  html += ".subtitle { color: #718096; font-size: 14px; }";
  html += ".nav-tabs { display: flex; background: #f7fafc; border-radius: 12px; padding: 4px; margin-bottom: 24px; }";
  html += ".nav-tab { flex: 1; text-align: center; padding: 12px; border-radius: 8px; text-decoration: none; color: #718096; font-weight: 500; transition: all 0.3s; }";
  html += ".nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }";
  html += ".nav-tab:hover:not(.active) { background: #edf2f7; color: #4a5568; }";
  html += ".card { background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%); border-radius: 20px; padding: 28px; margin-bottom: 24px; box-shadow: 0 8px 25px rgba(0,0,0,0.08), 0 0 0 1px rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); }";
  html += ".card:hover { transform: translateY(-2px); box-shadow: 0 12px 35px rgba(0,0,0,0.12), 0 0 0 1px rgba(255,255,255,0.9); }";
  html += ".card-title { color: #1a202c; font-size: 20px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }";
  html += ".form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; margin-bottom: 24px; }";
  html += ".form-group { position: relative; }";
  html += ".form-group label { display: block; margin-bottom: 8px; color: #2d3748; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }";
  html += ".form-group input { width: 100%; padding: 16px 20px; border: 2px solid rgba(226, 232, 240, 0.8); border-radius: 16px; font-size: 16px; font-weight: 500; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: linear-gradient(145deg, #ffffff 0%, #f7fafc 100%); box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }";
  html += ".form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15), inset 0 2px 4px rgba(0,0,0,0.02); transform: translateY(-1px); background: #ffffff; }";
  html += ".control-buttons { display: flex; gap: 16px; margin-top: 28px; flex-wrap: wrap; }";
  html += ".btn { padding: 16px 32px; border: none; border-radius: 16px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 10px; justify-content: center; text-transform: uppercase; letter-spacing: 0.5px; position: relative; overflow: hidden; }";
  html += ".btn:before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transition: left 0.5s; }";
  html += ".btn:hover:before { left: 100%; }";
  html += ".btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); flex: 1; min-width: 200px; }";
  html += ".btn-primary:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5); }";
  html += ".btn-secondary { background: linear-gradient(145deg, #ffffff 0%, #f7fafc 100%); color: #4a5568; border: 2px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }";
  html += ".btn-secondary:hover { background: linear-gradient(145deg, #f7fafc 0%, #edf2f7 100%); border-color: #cbd5e0; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }";
  html += ".btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }";
  html += ".btn:active { transform: translateY(0) scale(0.98); }";
  html += ".status-display { background: linear-gradient(145deg, #f8fafc 0%, #edf2f7 100%); border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: inset 0 2px 8px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.8); }";
  html += ".status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px; }";
  html += ".status-item { text-align: center; background: rgba(255,255,255,0.7); border-radius: 12px; padding: 16px; transition: all 0.3s; }";
  html += ".status-item:hover { background: rgba(255,255,255,0.9); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }";
  html += ".status-label { color: #4a5568; font-size: 13px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }";
  html += ".status-value { color: #1a202c; font-size: 22px; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }";
  html += ".canvas-container { background: linear-gradient(145deg, #f8fafc 0%, #ffffff 100%); border-radius: 24px; padding: 32px; margin: 20px 0; text-align: center; border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 8px 25px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8); position: relative; overflow: hidden; }";
  html += ".canvas-container:before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent); }";
  html += "#robotCanvas { border: 3px solid rgba(102, 126, 234, 0.2); border-radius: 20px; background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%); max-width: 100%; height: auto; display: block; margin: 0 auto; box-shadow: 0 8px 25px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8); transition: all 0.3s; }";
  html += "#robotCanvas:hover { border-color: rgba(102, 126, 234, 0.4); box-shadow: 0 12px 35px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.9); }";
  html += ".simulation-section { display: flex; flex-direction: column; height: fit-content; }";
  html += ".simulation-info { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; text-align: center; }";
  html += ".info-item { background: linear-gradient(145deg, #ffffff 0%, #f7fafc 100%); padding: 16px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.3s; }";
  html += ".info-item:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); background: #ffffff; }";
  html += ".info-label { display: block; font-size: 13px; color: #4a5568; font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }";
  html += ".info-value { font-size: 16px; color: #1a202c; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }";
  html += "canvas { border-radius: 12px; border: 2px solid #e2e8f0; background: #ffffff; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }";
  html += ".main-content { flex: 1; display: flex; gap: 30px; }";
  html += ".controls-section, .simulation-section { flex: 1; }";
  html += ".status { margin: 15px 0; padding: 12px 16px; border-radius: 12px; text-align: center; display: none; font-weight: 500; }";
  html += ".status.success { background: #f0fff4; color: #22543d; border: 2px solid #9ae6b4; }";
  html += ".status.error { background: #fff5f5; color: #742a2a; border: 2px solid #fed7d7; }";
  html += ".status.loading { background: #ebf8ff; color: #2a4365; border: 2px solid #90cdf4; }";
  html += ".back-btn { position: fixed; top: 20px; left: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: #4a5568; font-size: 18px; transition: all 0.3s; }";
  html += ".back-btn:hover { background: rgba(255,255,255,1); transform: scale(1.05); }";
  html += "@media (min-width: 768px) { ";
  html += ".main-content { display: flex; flex-direction: row; gap: 30px; align-items: flex-start; }";
  html += ".controls-section, .simulation-section { flex: 1; min-width: 0; }";
  html += ".canvas-container { margin: 0; }";
  html += "#robotCanvas { width: 100%; max-width: 450px; height: 450px; }";
  html += "}";
  html += "@media (min-width: 1200px) { ";
  html += ".main-content { gap: 40px; }";
  html += "#robotCanvas { max-width: 550px; height: 550px; }";
  html += "}";
  html += "@media (max-width: 767px) { ";
  html += "body { padding: 10px; align-items: flex-start; }";
  html += ".container { margin: 0; padding: 20px; max-width: 100%; min-height: auto; }";
  html += ".main-content { display: flex; flex-direction: column; gap: 20px; }";
  html += ".controls-section, .simulation-section { flex: none; }";
  html += ".form-grid { grid-template-columns: 1fr 1fr; }";
  html += ".control-buttons { grid-template-columns: 1fr; }";
  html += ".canvas-container { margin: 16px 0; }";
  html += "#robotCanvas { width: 100%; height: 300px; }";
  html += "}";
  html += "</style>";
  html += "</head>";
  html += "<body>";
  html += "<button class='back-btn' onclick='window.location.href=\"/\"'>‚Üê</button>";
  html += "<div class='container'>";
  html += "<div class='header'>";
  html += "<div class='header-icon'><i class='fa fa-robot'></i></div>";
  html += "<h1>Robot Arm Control</h1>";
  html += "<div class='subtitle'>XYZ Coordinate Control Mode</div>";
  html += "</div>";
  
  html += "<div class='nav-tabs'>";
  html += "<a href='/index' class='nav-tab active'>üéØ XYZ Mode</a>";
  html += "<a href='/joint' class='nav-tab'><i class='fa fa-cogs'></i> Joint Mode</a>";
  html += "</div>";
  
  html += "<div class='main-content'>";
  html += "<div class='controls-section'>";
  html += "<div class='card'>";
  html += "<div class='card-title'>üéØ Current Position</div>";
  html += "<div class='status-display'>";
  html += "<div class='status-grid'>";
  html += "<div class='status-item'><div class='status-label'>X</div><div class='status-value'>" + String(lastTheta1) + "</div></div>";
  html += "<div class='status-item'><div class='status-label'>Y</div><div class='status-value'>" + String(lastTheta2) + "</div></div>";
  html += "<div class='status-item'><div class='status-label'>Z</div><div class='status-value'>" + String(lastTheta3) + "</div></div>";
  html += "<div class='status-item'><div class='status-label'>Gripper</div><div class='status-value'>" + String(lastGripper) + "¬∞</div></div>";
  html += "</div>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<div class='card-title'>üéõÔ∏è Position Control</div>";
  html += "<div id='statusMessage' class='status'></div>";
  html += "<form id='controlForm'>";
  html += "<div class='form-grid'>";
  html += "<div class='form-group'><label for='theta1'>X Position</label><input type='number' id='theta1' name='theta1' value='" + String(lastTheta1) + "' step='1'></div>";
  html += "<div class='form-group'><label for='theta2'>Y Position</label><input type='number' id='theta2' name='theta2' value='" + String(lastTheta2) + "' step='1'></div>";
  html += "<div class='form-group'><label for='theta3'>Z Position</label><input type='number' id='theta3' name='theta3' value='" + String(lastTheta3) + "' step='1'></div>";
  html += "<div class='form-group'><label for='gripper'>Gripper (0-180¬∞)</label><input type='number' id='gripper' name='gripper' value='" + String(lastGripper) + "' min='0' max='180'></div>";
  html += "<div class='form-group'><label for='speed'>Speed</label><input type='number' id='speed' name='speed' value='" + String(lastSpeed) + "' min='100' max='3000'></div>";
  html += "<div class='form-group'><label for='acceleration'>Acceleration</label><input type='number' id='acceleration' name='acceleration' value='" + String(lastAcceleration) + "' min='50' max='1000'></div>";
  html += "</div>";
  html += "<div class='control-buttons'>";
  html += "<button type='submit' class='btn btn-primary' id='moveButton'>‚ñ∂Ô∏è Move to Position</button>";
  html += "<button type='button' class='btn btn-secondary' onclick='homeRobot()'>üè† Home</button>";
  html += "<button type='button' class='btn btn-secondary' onclick='zeroRobot()'>üéØ Zero</button>";
  html += "</div>";
  html += "</form>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class='simulation-section'>";
  html += "<div class='canvas-container'>";
  html += "<h3 style='color: #2d3748; margin-bottom: 12px;'>üëÅÔ∏è Robot Arm Simulation</h3>";
  html += "<canvas id='robotCanvas' width='340' height='340'></canvas>";
  html += "<div id='targetPos' style='text-align:center; margin-top:10px; font-weight:bold; color:#2d3748;'></div>";
  html += "<div class='simulation-info'>";
  html += "<div class='info-item'><span class='info-label'>Current Position</span><div class='info-value' id='currentPos'>X:" + String(endEffectorX, 1) + " Y:" + String(endEffectorY, 1) + " Z:" + String(endEffectorZ, 1) + "</div></div>";
  html += "<div class='info-item'><span class='info-label'>Workspace</span><div class='info-value'>200mm radius</div></div>";
  html += "</div>";
  html += "</div>";
  html += "</div>";
  
  html += "</div>";
  
  html += "</div>";
  // html += "<div class='container'>";
  // html += "<h1>Robot Arm Control</h1>";
  // html += "<div id='statusMessage' class='status'></div>";
  // html += "<form id='robotForm'>";
  // html += "<div class='form-group'><label for='theta1'>Joint 1 Angle</label><input type='number' id='theta1' name='theta1' value='" + String(lastTheta1) + "'></div>";
  // html += "<div class='form-group'><label for='theta2'>Joint 2 Angle</label><input type='number' id='theta2' name='theta2' value='" + String(lastTheta2) + "'></div>";
  // html += "<div class='form-group'><label for='theta3'>Joint 3 Angle</label><input type='number' id='theta3' name='theta3' value='" + String(lastTheta3) + "'></div>";
  // html += "<div class='form-group'><label for='gripper'>Gripper</label><input type='number' id='gripper' name='gripper' value='" + String(lastGripper) + "'></div>";
  // html += "<div class='form-group'><label for='speed'>Speed</label><input type='number' id='speed' name='speed' value='" + String(lastSpeed) + "'></div>";
  // html += "<div class='form-group'><label for='acceleration'>Acceleration</label><input type='number' id='acceleration' name='acceleration' value='" + String(lastAcceleration) + "'></div>";
  // html += "<button type='submit' id='moveButton'>Move</button>";
  // html += "</form>";
  // html += "<div class='effector'>";
  // html += "<h2 style='margin:0 0 10px 0;color:#2d3a4b;'>End Effector Position</h2>";
  // html += "<span>X: " + String(endEffectorX) + " mm</span> ";
  // html += "<span>Y: " + String(endEffectorY) + " mm</span> ";
  // html += "<span>Z: " + String(endEffectorZ) + " mm</span>";
  // html += "</div>";
  html += "<script>";
  html += "let isMoving = false;";
  html += "let currentPosition = { x: " + String(lastTheta1) + ", y: " + String(lastTheta2) + ", z: " + String(lastTheta3) + ", gripper: " + String(lastGripper) + " };";
  html += "const LINK1 = 135; const LINK2 = 147; const BASE_HEIGHT = 156.5;";
  html += "const ENDEFFECTER = 125; const WORK_SPACE = 210;";
  html += "const RadToDeg = 180 / Math.PI; const DegToRad = Math.PI / 180;";
  html += "function forwardKinematics(theta1, theta2, theta3) {";
  html += "  const d1 = Math.sin(theta1 * DegToRad) * LINK1;";
  html += "  const d2 = Math.cos(theta1 * DegToRad) * LINK1;";
  html += "  const d3 = Math.cos(theta2 * DegToRad) * LINK2;";
  html += "  const d4 = Math.sin(theta2 * DegToRad) * LINK2;";
  html += "  const x = Math.cos(theta3 * DegToRad) * (d1 + d3 + ENDEFFECTER);";
  html += "  const y = Math.sin(theta3 * DegToRad) * (d1 + d3 + ENDEFFECTER) + WORK_SPACE;";
  html += "  const z = Math.abs((d4 - d2) - BASE_HEIGHT);";
  html += "  return { x: x, y: y, z: z };";
  html += "}";
  html += "function inverseKinematics(x, y, z) {";
  html += "  const base_stant = BASE_HEIGHT - z;";
  html += "  const _y = Math.abs(y - WORK_SPACE);";
  html += "  let r = Math.sqrt(x * x + _y * _y);";
  html += "  const theta_base = Math.atan2(y - WORK_SPACE, x) * RadToDeg;";
  html += "  r = Math.abs(r - ENDEFFECTER);";
  html += "  const theta = Math.atan2(r, base_stant) * RadToDeg;";
  html += "  const g = Math.sqrt(r * r + base_stant * base_stant);";
  html += "  const alpha = Math.acos((LINK1 * LINK1 + g * g - LINK2 * LINK2) / (2 * LINK1 * g)) * RadToDeg;";
  html += "  const beta = alpha + theta;";
  html += "  const free = Math.acos((LINK1 * LINK1 + LINK2 * LINK2 - g * g) / (2 * LINK1 * LINK2)) * RadToDeg;";
  html += "  return {";
  html += "    theta1: 180 - beta,";
  html += "    theta2: (180 - free - alpha) + (180 - 90 - theta),";
  html += "    theta3: theta_base";
  html += "  };";
  html += "}";
  html += "function drawRobotArm() {";
  html += "  const canvas = document.getElementById('robotCanvas');";
  html += "  if (!canvas) return;";
  html += "  const ctx = canvas.getContext('2d');";
  html += "  const centerX = canvas.width / 2;";
  html += "  const centerY = canvas.height - 20;";
  html += "  ctx.clearRect(0, 0, canvas.width, canvas.height);";
  html += "  const x = parseFloat(document.getElementById('theta1').value) || 0;";
  html += "  const y = parseFloat(document.getElementById('theta2').value) || 0;";
  html += "  const z = parseFloat(document.getElementById('theta3').value) || 0;";
  html += "  const gripper = parseFloat(document.getElementById('gripper').value) || 0;";
  html += "  const ik = inverseKinematics(x, y, z);";
  html += "  console.log('Drawing robot arm:', {x, y, z, ik});";
  html += "  const scale = 0.6; const offsetY = 50;";
  html += "  ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1;";
  html += "  for(let i = 1; i <= 5; i++) { const radius = i * 30; ctx.beginPath(); ctx.arc(centerX, centerY - offsetY, radius, 0, 2*Math.PI); ctx.stroke(); }";
  html += "  ctx.strokeStyle = '#2d3748'; ctx.lineWidth = 4; ctx.lineCap = 'round';";
  html += "  const baseX = centerX;";
  html += "  const baseY = centerY - offsetY;";
  html += "  const theta1_rad = ik.theta1 * DegToRad;";
  html += "  const theta2_rad = ik.theta2 * DegToRad;";
  html += "  const theta3_rad = ik.theta3 * DegToRad;";
  html += "  const joint1X = baseX + (LINK1 * scale) * Math.cos(theta1_rad - Math.PI/2);";
  html += "  const joint1Y = baseY - (LINK1 * scale) * Math.sin(theta1_rad - Math.PI/2);";
  html += "  const joint2X = joint1X + (LINK2 * scale) * Math.cos(theta1_rad + theta2_rad - Math.PI/2);";
  html += "  const joint2Y = joint1Y - (LINK2 * scale) * Math.sin(theta1_rad + theta2_rad - Math.PI/2);";
  html += "  const endX = baseX + (x * scale * 0.5);";
  html += "  const endY = baseY - (z * scale * 0.5);";
  html += "  console.log('Positions:', {baseX, baseY, joint1X, joint1Y, joint2X, joint2Y, endX, endY});";
  html += "  ctx.beginPath(); ctx.moveTo(baseX, baseY); ctx.lineTo(joint1X, joint1Y); ctx.stroke();";
  html += "  ctx.beginPath(); ctx.moveTo(joint1X, joint1Y); ctx.lineTo(joint2X, joint2Y); ctx.stroke();";
  html += "  ctx.fillStyle = '#667eea'; ctx.beginPath(); ctx.arc(baseX, baseY, 8, 0, 2*Math.PI); ctx.fill();";
  html += "  ctx.fillStyle = '#764ba2'; ctx.beginPath(); ctx.arc(joint1X, joint1Y, 6, 0, 2*Math.PI); ctx.fill();";
  html += "  ctx.fillStyle = '#4a5568'; ctx.beginPath(); ctx.arc(joint2X, joint2Y, 4, 0, 2*Math.PI); ctx.fill();";
  html += "  ctx.fillStyle = gripper > 90 ? '#22543d' : '#742a2a';";
  html += "  ctx.fillRect(joint2X-3, joint2Y-3, 6, 6);";
  html += "  ctx.beginPath(); ctx.moveTo(baseX, baseY); ctx.lineTo(joint1X, joint1Y); ctx.stroke();";
  html += "  ctx.beginPath(); ctx.moveTo(joint1X, joint1Y); ctx.lineTo(endX, endY); ctx.stroke();";
  html += "  ctx.fillStyle = '#667eea'; ctx.beginPath(); ctx.arc(baseX, baseY, 8, 0, 2*Math.PI); ctx.fill();";
  html += "  ctx.fillStyle = '#764ba2'; ctx.beginPath(); ctx.arc(joint1X, joint1Y, 6, 0, 2*Math.PI); ctx.fill();";
  html += "  ctx.fillStyle = gripper > 90 ? '#22543d' : '#742a2a';";
  html += "  ctx.fillRect(joint2X-3, joint2Y-3, 6, 6);";
  html += "  const gripperSize = gripper / 18;";
  html += "  ctx.strokeStyle = ctx.fillStyle; ctx.lineWidth = 2;";
  html += "  ctx.beginPath(); ctx.moveTo(joint2X-gripperSize, joint2Y-5); ctx.lineTo(joint2X-gripperSize, joint2Y+5); ctx.stroke();";
  html += "  ctx.beginPath(); ctx.moveTo(joint2X+gripperSize, joint2Y-5); ctx.lineTo(joint2X+gripperSize, joint2Y+5); ctx.stroke();";
  html += "  ctx.fillStyle = '#2d3748'; ctx.font = '10px Arial';";
  html += "  ctx.fillText('Base', baseX-15, baseY+20);";
  html += "  const targetPosEl = document.getElementById('targetPos');";
  html += "  if (targetPosEl) targetPosEl.textContent = `X:${x.toFixed(1)} Y:${y.toFixed(1)} Z:${z.toFixed(1)} | Œ∏1:${ik.theta1.toFixed(1)}¬∞ Œ∏2:${ik.theta2.toFixed(1)}¬∞ Œ∏3:${ik.theta3.toFixed(1)}¬∞`;";
  html += "}";
  html += "function showStatus(message, type) {";
  html += "  const statusDiv = document.getElementById('statusMessage');";
  html += "  if (!statusDiv) return;";
  html += "  statusDiv.textContent = message;";
  html += "  statusDiv.className = 'status ' + type;";
  html += "  statusDiv.style.display = 'block';";
  html += "  if (type !== 'loading') {";
  html += "    setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);";
  html += "  }";
  html += "}";
  html += "function updateCurrentPosition() {";
  html += "  const currentX = document.getElementById('currentX');";
  html += "  const currentY = document.getElementById('currentY');";
  html += "  const currentZ = document.getElementById('currentZ');";
  html += "  const currentGripper = document.getElementById('currentGripper');";
  html += "  if (currentX) currentX.textContent = currentPosition.x + ' mm';";
  html += "  if (currentY) currentY.textContent = currentPosition.y + ' mm';";
  html += "  if (currentZ) currentZ.textContent = currentPosition.z + ' mm';";
  html += "  if (currentGripper) currentGripper.textContent = currentPosition.gripper + '¬∞';";
  html += "  drawRobotArm();";
  html += "}";
  html += "function updateUI(disabled) {";
  html += "  document.getElementById('moveButton').disabled = disabled;";
  html += "  const btn = document.getElementById('moveButton');";
  html += "  btn.innerHTML = disabled ? '‚è≥ Moving...' : '‚ñ∂Ô∏è Move to Position';";
  html += "}";
  html += "['theta1', 'theta2', 'theta3', 'gripper'].forEach(id => {";
  html += "  document.getElementById(id).addEventListener('input', drawRobotArm);";
  html += "});";
  html += "function homeRobot() {";
  html += "  showStatus('Moving to home position...', 'loading');";
  html += "  fetch('/gohomevalue', {method: 'GET'})";
  html += "    .then(response => {";
  html += "      if (response.ok) {";
  html += "        showStatus('Home position reached!', 'success');";
  html += "        setTimeout(() => { location.reload(); }, 1500);";
  html += "      } else {";
  html += "        throw new Error('Network response was not ok');";
  html += "      }";
  html += "    })";
  html += "    .catch(error => {";
  html += "      console.error('Error:', error);";
  html += "      showStatus('Error going to home position.', 'error');";
  html += "    });";
  html += "}";
  html += "function zeroRobot() {";
  html += "  ['theta1', 'theta2', 'theta3'].forEach(id => {";
  html += "    document.getElementById(id).value = 0;";
  html += "  });";
  html += "  drawRobotArm();";
  html += "  showStatus('Set to zero position. Click Move to apply.', 'success');";
  html += "}";
  html += "function emergencyStop() {";
  html += "  fetch('/stop', {method: 'POST'})";
  html += "    .then(() => showStatus('Emergency stop activated!', 'error'))";
  html += "    .catch(() => showStatus('Connection error', 'error'));";
  html += "}";
  html += "document.addEventListener('DOMContentLoaded', function() { drawRobotArm(); });";
  html += "document.getElementById('controlForm').addEventListener('submit', function(e) {";
  html += "  e.preventDefault();";
  html += "  if (isMoving) return;";
  html += "  isMoving = true;";
  html += "  updateUI(true);";
  html += "  showStatus('Sending movement command...', 'loading');";
  html += "  const formData = new FormData(this);";
  html += "  const params = new URLSearchParams();";
  html += "  formData.set('mode', 'XYZ');";
  html += "  for (const [key, value] of formData.entries()) {";
  html += "    params.append(key, value);";
  html += "  }";
  html += "  fetch('/move?' + params.toString(), { method: 'GET' })";
  html += "    .then(response => {";
  html += "      if (response.ok) {";
  html += "        currentPosition.x = parseInt(document.getElementById('theta1').value);";
  html += "        currentPosition.y = parseInt(document.getElementById('theta2').value);";
  html += "        currentPosition.z = parseInt(document.getElementById('theta3').value);";
  html += "        currentPosition.gripper = parseInt(document.getElementById('gripper').value);";
  html += "        updateCurrentPosition();";
  html += "        showStatus('Movement completed successfully!', 'success');";
  html += "      } else {";
  html += "        throw new Error('Movement failed');";
  html += "      }";
  html += "    })";
  html += "    .catch(error => {";
  html += "      console.error('Error:', error);";
  html += "      showStatus('Error sending command. Please try again.', 'error');";
  html += "    })";
  html += "    .finally(() => {";
  html += "      isMoving = false;";
  html += "      updateUI(false);";
  html += "    });";
  html += "});";
  html += "function drawRobotVisualization() {";
  html += "  const canvas = document.getElementById('robotCanvas');";
  html += "  const ctx = canvas.getContext('2d');";
  html += "  ctx.clearRect(0, 0, canvas.width, canvas.height);";
  html += "  ctx.fillStyle = '#f8fafc';";
  html += "  ctx.fillRect(0, 0, canvas.width, canvas.height);";
  html += "  const centerX = canvas.width / 2;";
  html += "  const centerY = canvas.height - 30;";
  html += "  const scale = 0.8;";
  html += "  const x = currentPosition.x * scale + centerX;";
  html += "  const y = centerY - (currentPosition.y * scale);";
  html += "  ctx.strokeStyle = '#e2e8f0';";
  html += "  ctx.lineWidth = 1;";
  html += "  for (let i = 0; i < canvas.width; i += 20) {";
  html += "    ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke();";
  html += "  }";
  html += "  for (let i = 0; i < canvas.height; i += 20) {";
  html += "    ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(canvas.width, i); ctx.stroke();";
  html += "  }";
  html += "  ctx.strokeStyle = '#667eea';";
  html += "  ctx.lineWidth = 3;";
  html += "  ctx.beginPath();";
  html += "  ctx.moveTo(centerX, centerY);";
  html += "  ctx.lineTo(x, y);";
  html += "  ctx.stroke();";
  html += "  ctx.fillStyle = '#667eea';";
  html += "  ctx.beginPath();";
  html += "  ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);";
  html += "  ctx.fill();";
  html += "  ctx.fillStyle = '#e53e3e';";
  html += "  ctx.beginPath();";
  html += "  ctx.arc(x, y, 6, 0, 2 * Math.PI);";
  html += "  ctx.fill();";
  html += "  ctx.fillStyle = '#2d3748';";
  html += "  ctx.font = '12px Inter, sans-serif';";
  html += "  ctx.fillText('Base', centerX - 15, centerY + 20);";
  html += "  ctx.fillText(`(${currentPosition.x}, ${currentPosition.y}, ${currentPosition.z})`, x - 30, y - 10);";
  html += "}";
  html += "document.addEventListener('DOMContentLoaded', function() {";
  html += "  drawRobotVisualization();";
  html += "  const inputs = document.querySelectorAll('input[type=\"number\"]');";
  html += "  inputs.forEach(input => {";
  html += "    input.addEventListener('input', function() {";
  html += "      this.style.borderColor = '#667eea';";
  html += "      setTimeout(() => { this.style.borderColor = '#e2e8f0'; }, 1000);";
  html += "    });";
  html += "  });";
  html += "});";
  html += "</script>";
  html += "</body></html>";
  return html;
}

String generateJointControlPage(int lastTheta1_joint, int lastTheta2_joint, int lastTheta3_joint,
                               int lastGripper, int lastSpeed, int lastAcceleration,
                               double endEffectorX, double endEffectorY, double endEffectorZ) {
  String html = "<!DOCTYPE html>";
  html += "<html lang=\"en\">";
  html += "<head>";
  html += "<meta charset=\"UTF-8\">";
  html += "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">";
  html += "<title>Robot Arm Control - Joint Mode</title>";
  html += "<style>";
  html += getInlineIcons();
  html += "* { margin: 0; padding: 0; box-sizing: border-box; }";
  html += "body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; min-height: 100vh; padding: 20px; display: flex; align-items: center; justify-content: center; }";
  html += ".container { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); max-width: 1400px; width: 100%; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.1); padding: 40px; animation: slideUp 0.8s ease-out; min-height: 85vh; display: flex; flex-direction: column; }";
  html += "@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }";
  html += ".header { text-align: center; margin-bottom: 40px; position: relative; }";
  html += ".header:before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%); border-radius: 50%; z-index: -1; }";
  html += ".header-icon { font-size: 48px; margin-bottom: 16px; filter: drop-shadow(0 4px 8px rgba(102, 126, 234, 0.3)); }";
  html += "h1 { color: #1a202c; font-size: 32px; font-weight: 800; margin-bottom: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }";
  html += ".subtitle { color: #4a5568; font-size: 16px; font-weight: 500; }";
  html += ".nav-tabs { display: flex; background: linear-gradient(145deg, #f7fafc 0%, #edf2f7 100%); border-radius: 20px; padding: 6px; margin-bottom: 32px; box-shadow: inset 0 2px 8px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.8); }";
  html += ".nav-tab { flex: 1; text-align: center; padding: 16px 24px; border-radius: 16px; text-decoration: none; color: #4a5568; font-weight: 600; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }";
  html += ".nav-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4), inset 0 1px 0 rgba(255,255,255,0.2); transform: translateY(-1px); }";
  html += ".nav-tab:hover:not(.active) { background: linear-gradient(145deg, #ffffff 0%, #f7fafc 100%); color: #2d3748; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }";
  html += ".card { background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%); border-radius: 20px; padding: 28px; margin-bottom: 24px; box-shadow: 0 8px 25px rgba(0,0,0,0.08), 0 0 0 1px rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); }";
  html += ".card:hover { transform: translateY(-2px); box-shadow: 0 12px 35px rgba(0,0,0,0.12), 0 0 0 1px rgba(255,255,255,0.9); }";
  html += ".card-title { color: #1a202c; font-size: 20px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }";
  html += ".joint-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 24px; margin-bottom: 28px; }";
  html += ".joint-group { background: linear-gradient(145deg, #f8fafc 0%, #ffffff 100%); border-radius: 20px; padding: 24px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.6); transition: all 0.3s; }";
  html += ".joint-group:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.9); }";
  html += ".joint-title { color: #2d3748; font-size: 15px; font-weight: 700; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }";
  html += ".joint-value { color: #1a202c; font-size: 28px; font-weight: 800; margin-bottom: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }";
  html += ".joint-slider { width: 100%; height: 8px; border-radius: 6px; background: linear-gradient(90deg, #e2e8f0 0%, #cbd5e0 100%); outline: none; margin-bottom: 12px; transition: all 0.3s; }";
  html += ".joint-slider:hover { background: linear-gradient(90deg, #cbd5e0 0%, #a0aec0 100%); }";
  html += ".joint-slider::-webkit-slider-thumb { appearance: none; width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); transition: all 0.3s; }";
  html += ".joint-slider::-webkit-slider-thumb:hover { transform: scale(1.1); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5); }";
  html += ".joint-input { width: 100%; padding: 12px 16px; border: 2px solid rgba(226, 232, 240, 0.8); border-radius: 12px; text-align: center; font-weight: 600; font-size: 16px; background: linear-gradient(145deg, #ffffff 0%, #f7fafc 100%); transition: all 0.3s; }";
  html += ".joint-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15); transform: translateY(-1px); background: #ffffff; }";
  html += ".form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-bottom: 20px; }";
  html += ".form-group { position: relative; }";
  html += ".form-group label { display: block; margin-bottom: 6px; color: #4a5568; font-weight: 500; font-size: 14px; }";
  html += ".form-group input { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; transition: all 0.3s; background: #ffffff; }";
  html += ".form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }";
  html += ".control-buttons { display: grid; grid-template-columns: 1fr auto auto auto; gap: 12px; margin-top: 20px; }";
  html += ".btn { padding: 12px 20px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; justify-content: center; }";
  html += ".btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }";
  html += ".btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }";
  html += ".btn-secondary { background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; }";
  html += ".btn-secondary:hover { background: #edf2f7; border-color: #cbd5e0; }";
  html += ".btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }";
  html += ".status { margin: 15px 0; padding: 12px 16px; border-radius: 12px; text-align: center; display: none; font-weight: 500; }";
  html += ".status.success { background: #f0fff4; color: #22543d; border: 2px solid #9ae6b4; }";
  html += ".status.error { background: #fff5f5; color: #742a2a; border: 2px solid #fed7d7; }";
  html += ".status.loading { background: #ebf8ff; color: #2a4365; border: 2px solid #90cdf4; }";
  html += ".back-btn { position: fixed; top: 20px; left: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: #4a5568; font-size: 18px; transition: all 0.3s; }";
  html += ".back-btn:hover { background: rgba(255,255,255,1); transform: scale(1.05); }";
  html += ".effector-info { background: #f8fafc; border-radius: 12px; padding: 16px; margin-top: 20px; }";
  html += ".effector-title { color: #2d3748; font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }";
  html += ".effector-values { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }";
  html += ".effector-value { background: #ffffff; border-radius: 8px; padding: 12px; text-align: center; }";
  html += ".effector-label { color: #718096; font-size: 12px; font-weight: 500; }";
  html += ".effector-number { color: #2d3748; font-size: 16px; font-weight: 700; }";
  html += ".canvas-container { background: #f8fafc; border-radius: 16px; padding: 24px; margin: 20px 0; text-align: center; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }";
  html += "#jointCanvas { border: 3px solid rgba(102, 126, 234, 0.2); border-radius: 20px; background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%); max-width: 100%; height: auto; display: block; margin: 0 auto; box-shadow: 0 8px 25px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8); transition: all 0.3s; }";
  html += "#jointCanvas:hover { border-color: rgba(102, 126, 234, 0.4); box-shadow: 0 12px 35px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.9); }";
  html += ".main-content { flex: 1; display: flex; gap: 30px; }";
  html += ".controls-section, .simulation-section { flex: 1; }";
  html += ".simulation-section { display: flex; flex-direction: column; height: fit-content; }";
  html += ".simulation-info { margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; text-align: center; }";
  html += ".info-item { background: #ffffff; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }";
  html += ".info-label { display: block; font-size: 12px; color: #718096; font-weight: 500; }";
  html += ".info-value { font-size: 14px; color: #2d3748; font-weight: 600; }";
  html += "@media (min-width: 768px) { ";
  html += ".main-content { display: flex; flex-direction: row; gap: 30px; align-items: flex-start; }";
  html += ".controls-section, .simulation-section { flex: 1; min-width: 0; }";
  html += ".canvas-container { margin: 0; }";
  html += "#jointCanvas { width: 100%; max-width: 450px; height: 450px; }";
  html += "}";
  html += "@media (min-width: 1200px) { ";
  html += ".main-content { gap: 40px; }";
  html += "#jointCanvas { max-width: 550px; height: 550px; }";
  html += "}";
  html += "@media (max-width: 767px) { ";
  html += "body { padding: 10px; align-items: flex-start; }";
  html += ".container { margin: 0; padding: 20px; max-width: 100%; min-height: auto; }";
  html += ".main-content { display: flex; flex-direction: column; gap: 20px; }";
  html += ".controls-section, .simulation-section { flex: none; }";
  html += ".joint-controls { grid-template-columns: 1fr; }";
  html += ".control-buttons { grid-template-columns: 1fr; gap: 8px; }";
  html += ".canvas-container { margin: 16px 0; }";
  html += "#jointCanvas { width: 100%; height: 300px; }";
  html += "}";
  html += "</style>";
  html += "</head>";
  html += "<body>";
  html += "<button class='back-btn' onclick='window.location.href=\"/\"'>‚Üê</button>";
  html += "<div class='container'>";
  html += "<div class='header'>";
  html += "<div class='header-icon'><i class='fa fa-robot'></i></div>";
  html += "<h1>Robot Arm Control</h1>";
  html += "<div class='subtitle'>Joint Angle Control Mode</div>";
  html += "</div>";
  
  html += "<div class='nav-tabs'>";
  html += "<a href='/index' class='nav-tab'>üéØ XYZ Mode</a>";
  html += "<a href='/joint' class='nav-tab active'><i class='fa fa-cogs'></i> Joint Mode</a>";
  html += "</div>";
  
  html += "<div class='main-content'>";
  html += "<div class='controls-section'>";
  html += "<div class='card'>";
  html += "<div class='card-title'><i class='fa fa-cogs'></i> Joint Control</div>";
  html += "<div id='statusMessage' class='status'></div>";
  html += "<form id='jointForm'>";
  html += "<div class='card-title'>üéõÔ∏è Joint Angles</div>";
  html += "<div class='joint-controls'>";
  html += "<div class='joint-group'>";
  html += "<div class='joint-title'>Joint 1 (Elbow)</div>";
  html += "<div class='joint-value' id='theta1-display'>" + String(lastTheta1_joint) + "¬∞</div>";
  html += "<input type='range' class='joint-slider' id='theta1-slider' min='-180' max='180' value='" + String(lastTheta1_joint) + "' oninput='updateJointValue(1, this.value)'>";
  html += "<input type='number' class='joint-input' id='theta1' name='theta1' value='" + String(lastTheta1_joint) + "' min='-180' max='180' onchange='updateSlider(1, this.value)' oninput='drawJointSimulation()'>";
  html += "</div>";
  html += "<div class='joint-group'>";
  html += "<div class='joint-title'>Joint 2 (Shoulder)</div>";
  html += "<div class='joint-value' id='theta2-display'>" + String(lastTheta2_joint) + "¬∞</div>";
  html += "<input type='range' class='joint-slider' id='theta2-slider' min='-180' max='180' value='" + String(lastTheta2_joint) + "' oninput='updateJointValue(2, this.value)'>";
  html += "<input type='number' class='joint-input' id='theta2' name='theta2' value='" + String(lastTheta2_joint) + "' min='-180' max='180' onchange='updateSlider(2, this.value)' oninput='drawJointSimulation()'>";
  html += "</div>";
  html += "<div class='joint-group'>";
  html += "<div class='joint-title'>Joint 3 (Base)</div>";
  html += "<div class='joint-value' id='theta3-display'>" + String(lastTheta3_joint) + "¬∞</div>";
  html += "<input type='range' class='joint-slider' id='theta3-slider' min='-180' max='180' value='" + String(lastTheta3_joint) + "' oninput='updateJointValue(3, this.value)'>";
  html += "<input type='number' class='joint-input' id='theta3' name='theta3' value='" + String(lastTheta3_joint) + "' min='-180' max='180' onchange='updateSlider(3, this.value)' oninput='drawJointSimulation()'>";
  html += "</div>";
  html += "</div>";
  html += "<div class='form-grid'>";
  html += "<div class='form-group'><label for='gripper'>Gripper (0-180¬∞)</label><input type='number' id='gripper' name='gripper' value='" + String(lastGripper) + "' min='0' max='180' oninput='drawJointSimulation()'></div>";
  html += "<div class='form-group'><label for='speed'>Speed</label><input type='number' id='speed' name='speed' value='" + String(lastSpeed) + "' min='100' max='3000'></div>";
  html += "<div class='form-group'><label for='acceleration'>Acceleration</label><input type='number' id='acceleration' name='acceleration' value='" + String(lastAcceleration) + "' min='50' max='1000'></div>";
  html += "</div>";
  html += "<div class='control-buttons'>";
  html += "<button type='submit' class='btn btn-primary' id='moveButton'>‚ñ∂Ô∏è Move Joints</button>";
  html += "<button type='button' class='btn btn-secondary' onclick='homeRobot()'>üè† Home</button>";
  html += "<button type='button' class='btn btn-secondary' onclick='zeroRobot()'>üéØ Zero</button>";
  html += "<button type='button' class='btn btn-secondary' onclick='setHomeValue()'>üîñ Set</button>";
  html += "</div>";
  html += "</form>";
  html += "</div>";
  
  html += "<div class='effector-info'>";
  html += "<div class='effector-title'>üéØ End Effector Position</div>";
  html += "<div class='effector-values'>";
  html += "<div class='effector-value'><div class='effector-label'>X-Axis</div><div class='effector-number'>" + String(endEffectorX, 1) + " mm</div></div>";
  html += "<div class='effector-value'><div class='effector-label'>Y-Axis</div><div class='effector-number'>" + String(endEffectorY, 1) + " mm</div></div>";
  html += "<div class='effector-value'><div class='effector-label'>Z-Axis</div><div class='effector-number'>" + String(endEffectorZ, 1) + " mm</div></div>";
  html += "</div>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class='simulation-section'>";
  html += "<div class='canvas-container'>";
  html += "<h3 style='color: #2d3748; margin-bottom: 12px;'><i class='fa fa-cogs'></i> Joint Simulation</h3>";
  html += "<canvas id='jointCanvas' width='340' height='340'></canvas>";
  html += "<div class='simulation-info'>";
  html += "<div class='info-item'><span class='info-label'>Joint Mode</span><div class='info-value'>Active</div></div>";
  html += "<div class='info-item'><span class='info-label'>Workspace</span><div class='info-value'>200mm radius</div></div>";
  html += "</div>";
  html += "</div>";
  html += "</div>";
  
  html += "</div>";
  
  html += "</div>";
  
  html += "<script>";
  html += "let isMoving = false;";
  html += "const LINK1 = 135, LINK2 = 147, BASE_HEIGHT = 156.5;";
  html += "const ENDEFFECTER = 125, WORK_SPACE = 210;";
  html += "const RadToDeg = 180 / Math.PI, DegToRad = Math.PI / 180;";
  html += "function forwardKinematics(theta1, theta2, theta3) {";
  html += "  const d1 = Math.sin(theta1 * DegToRad) * LINK1;";
  html += "  const d2 = Math.cos(theta1 * DegToRad) * LINK1;";
  html += "  const d3 = Math.cos(theta2 * DegToRad) * LINK2;";
  html += "  const d4 = Math.sin(theta2 * DegToRad) * LINK2;";
  html += "  const x = Math.cos(theta3 * DegToRad) * (d1 + d3 + ENDEFFECTER);";
  html += "  const y = Math.sin(theta3 * DegToRad) * (d1 + d3 + ENDEFFECTER) + WORK_SPACE;";
  html += "  const z = Math.abs((d4 - d2) - BASE_HEIGHT);";
  html += "  return { x: x, y: y, z: z };";
  html += "}";
  html += "function updateJointValue(joint, value) {";
  html += "  const thetaDisplay = document.getElementById(`theta${joint}-display`);";
  html += "  const thetaInput = document.getElementById(`theta${joint}`);";
  html += "  const jAngle = document.getElementById(`j${joint}-angle`);";
  html += "  if (thetaDisplay) thetaDisplay.textContent = value + '¬∞';";
  html += "  if (thetaInput) thetaInput.value = value;";
  html += "  if (jAngle) jAngle.textContent = value + '¬∞';";
  html += "  drawJointSimulation();";
  html += "}";
  html += "function updateSlider(joint, value) {";
  html += "  const thetaSlider = document.getElementById(`theta${joint}-slider`);";
  html += "  const thetaDisplay = document.getElementById(`theta${joint}-display`);";
  html += "  const jAngle = document.getElementById(`j${joint}-angle`);";
  html += "  if (thetaSlider) thetaSlider.value = value;";
  html += "  if (thetaDisplay) thetaDisplay.textContent = value + '¬∞';";
  html += "  if (jAngle) jAngle.textContent = value + '¬∞';";
  html += "  drawJointSimulation();";
  html += "}";
  html += "function drawJointSimulation() {";
  html += "  const canvas = document.getElementById('jointCanvas');";
  html += "  if (!canvas) return;";
  html += "  const ctx = canvas.getContext('2d');";
  html += "  const centerX = canvas.width / 2;";
  html += "  const centerY = canvas.height - 20;";
  html += "  const scale = 0.6; const offsetY = 50;";
  html += "  const DegToRad = Math.PI / 180;";
  html += "  ctx.clearRect(0, 0, canvas.width, canvas.height);";
  html += "  const theta1 = parseFloat(document.getElementById('theta1').value) || 0;";
  html += "  const theta2 = parseFloat(document.getElementById('theta2').value) || 0;";
  html += "  const theta3 = parseFloat(document.getElementById('theta3').value) || 0;";
  html += "  const gripper = parseFloat(document.getElementById('gripper').value) || 0;";
  html += "  const fk = forwardKinematics(theta1, theta2, theta3);";
  html += "  ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1;";
  html += "  for(let i = 1; i <= 4; i++) { const r = i * 40; ctx.beginPath(); ctx.arc(centerX, centerY - offsetY, r, 0, 2*Math.PI); ctx.stroke(); }";
  html += "  const baseX = centerX, baseY = centerY - offsetY;";
  html += "  const theta1_rad = theta1 * DegToRad;";
  html += "  const theta2_rad = theta2 * DegToRad;";
  html += "  const joint1X = baseX + (LINK1 * scale) * Math.cos(theta1_rad - Math.PI/2);";
  html += "  const joint1Y = baseY - (LINK1 * scale) * Math.sin(theta1_rad - Math.PI/2);";
  html += "  const joint2X = joint1X + (LINK2 * scale) * Math.cos(theta1_rad + theta2_rad - Math.PI/2);";
  html += "  const joint2Y = joint1Y - (LINK2 * scale) * Math.sin(theta1_rad + theta2_rad - Math.PI/2);";
  html += "  ctx.strokeStyle = '#667eea'; ctx.lineWidth = 6; ctx.lineCap = 'round';";
  html += "  ctx.beginPath(); ctx.moveTo(baseX, baseY); ctx.lineTo(joint1X, joint1Y); ctx.stroke();";
  html += "  ctx.strokeStyle = '#764ba2'; ctx.lineWidth = 5;";
  html += "  ctx.beginPath(); ctx.moveTo(joint1X, joint1Y); ctx.lineTo(joint2X, joint2Y); ctx.stroke();";
  html += "  ctx.fillStyle = '#2d3748'; ctx.beginPath(); ctx.arc(baseX, baseY, 8, 0, 2*Math.PI); ctx.fill();";
  html += "  ctx.fillStyle = '#4a5568'; ctx.beginPath(); ctx.arc(joint1X, joint1Y, 6, 0, 2*Math.PI); ctx.fill();";
  html += "  ctx.fillStyle = gripper > 90 ? '#22543d' : '#742a2a';";
  html += "  ctx.fillRect(joint2X-4, joint2Y-4, 8, 8);";
  html += "  const gripperSize = gripper / 20;";
  html += "  ctx.strokeStyle = ctx.fillStyle; ctx.lineWidth = 3;";
  html += "  ctx.beginPath(); ctx.moveTo(joint2X-gripperSize, joint2Y-6); ctx.lineTo(joint2X-gripperSize, joint2Y+6); ctx.stroke();";
  html += "  ctx.beginPath(); ctx.moveTo(joint2X+gripperSize, joint2Y-6); ctx.lineTo(joint2X+gripperSize, joint2Y+6); ctx.stroke();";
  html += "  ctx.fillStyle = '#2d3748'; ctx.font = '12px Arial';";
  html += "  ctx.fillText(`FK: X:${fk.x.toFixed(1)} Y:${fk.y.toFixed(1)} Z:${fk.z.toFixed(1)}`, 10, 20);";
  html += "  ctx.fillText(`Joints: Œ∏1:${theta1}¬∞ Œ∏2:${theta2}¬∞ Œ∏3:${theta3}¬∞`, 10, 35);";
  html += "  ctx.fillText('Base', baseX-15, baseY+20);";
  html += "}";
  html += "function showStatus(message, type) {";
  html += "  const statusDiv = document.getElementById('statusMessage');";
  html += "  if (!statusDiv) return;";
  html += "  statusDiv.textContent = message;";
  html += "  statusDiv.className = 'status ' + type;";
  html += "  statusDiv.style.display = 'block';";
  html += "  if (type !== 'loading') {";
  html += "    setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);";
  html += "  }";
  html += "}";
  html += "function updateUI(disabled) {";
  html += "  document.getElementById('moveButton').disabled = disabled;";
  html += "  const btn = document.getElementById('moveButton');";
  html += "  btn.innerHTML = disabled ? '‚è≥ Moving...' : '‚ñ∂Ô∏è Move Joints';";
  html += "}";
  html += "function homeRobot() {";
  html += "  showStatus('Going to home position...', 'loading');";
  html += "  fetch('/gohomevalue', {method: 'GET'})";
  html += "    .then(response => {";
  html += "      if (response.ok) {";
  html += "        showStatus('Home position reached successfully!', 'success');";
  html += "        setTimeout(() => { location.reload(); }, 1500);";
  html += "      } else {";
  html += "        throw new Error('Network response was not ok');";
  html += "      }";
  html += "    })";
  html += "    .catch(error => {";
  html += "      console.error('Error:', error);";
  html += "      showStatus('Error going to home position.', 'error');";
  html += "    });";
  html += "}";
  html += "function zeroRobot() {";
  html += "  showStatus('Moving to zero position...', 'loading');";
  html += "  for(let i = 1; i <= 3; i++) {";
  html += "    const thetaInput = document.getElementById(`theta${i}`);";
  html += "    const thetaSlider = document.getElementById(`theta${i}-slider`);";
  html += "    const thetaDisplay = document.getElementById(`theta${i}-display`);";
  html += "    if (thetaInput) thetaInput.value = 0;";
  html += "    if (thetaSlider) thetaSlider.value = 0;";
  html += "    if (thetaDisplay) thetaDisplay.textContent = '0¬∞';";
  html += "  }";
  html += "  showStatus('Set to zero position. Click Move to apply.', 'success');";
  html += "}";
  html += "function setHomeValue() {";
  html += "  showStatus('Setting current position as home...', 'loading');";
  html += "  fetch('/sethomevalue', {method: 'GET'})";
  html += "    .then(response => {";
  html += "      if (response.ok) {";
  html += "        showStatus('Home value set successfully!', 'success');";
  html += "      } else {";
  html += "        throw new Error('Network response was not ok');";
  html += "      }";
  html += "    })";
  html += "    .catch(error => {";
  html += "      console.error('Error:', error);";
  html += "      showStatus('Error setting home value.', 'error');";
  html += "    });";
  html += "}";
  html += "document.addEventListener('DOMContentLoaded', function() { drawJointSimulation(); });";
  html += "document.getElementById('jointForm').addEventListener('submit', function(e) {";
  html += "  e.preventDefault();";
  html += "  if (isMoving) return;";
  html += "  isMoving = true;";
  html += "  updateUI(true);";
  html += "  showStatus('Sending joint movement command...', 'loading');";
  html += "  const formData = new FormData(this);";
  html += "  const params = new URLSearchParams();";
  html += "  formData.set('mode', 'JOINT');";
  html += "  for (const [key, value] of formData.entries()) {";
  html += "    params.append(key, value);";
  html += "    console.log(`${key}: ${value}`);";
  html += "  }";
  html += "  console.log('Sending params:', params.toString());";
  html += "  fetch('/movejoint?' + params.toString(), { method: 'GET' })";
  html += "    .then(response => {";
  html += "      if (response.ok) {";
  html += "        showStatus('Joint movement command sent successfully!', 'success');";
  html += "        setTimeout(() => { location.reload(); }, 1500);";
  html += "      } else {";
  html += "        throw new Error('Network response was not ok');";
  html += "      }";
  html += "    })";
  html += "    .catch(error => {";
  html += "      console.error('Error:', error);";
  html += "      showStatus('Error sending joint command. Please try again.', 'error');";
  html += "    })";
  html += "    .finally(() => {";
  html += "      isMoving = false;";
  html += "      updateUI(false);";
  html += "    });";
  html += "});";
  html += "</script>";
  html += "</body></html>";
  return html;
}

String generateGcodePage() {
  String html = "<!DOCTYPE html>";
  html += "<html lang=\"en\">";
  html += "<head>";
  html += "<meta charset=\"UTF-8\">";
  html += "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">";
  html += "<title>Robot Arm Control - G-code Mode</title>";
  html += getInlineIcons();
  html += "<style>";
  html += "* { margin: 0; padding: 0; box-sizing: border-box; }";
  html += "body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; min-height: 100vh; padding: 20px; }";
  html += ".container { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); max-width: 600px; margin: 0 auto; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.1); padding: 32px; animation: slideUp 0.8s ease-out; }";
  html += "@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }";
  html += ".header { text-align: center; margin-bottom: 32px; }";
  html += ".header-icon { font-size: 40px; color: #667eea; margin-bottom: 12px; }";
  html += "h1 { color: #2d3748; font-size: 24px; font-weight: 700; margin-bottom: 8px; }";
  html += ".subtitle { color: #718096; font-size: 14px; }";
  html += ".card { background: #ffffff; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }";
  html += ".card-title { color: #2d3748; font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }";
  html += ".card-title i { color: #667eea; }";
  html += ".form-group { margin-bottom: 20px; }";
  html += ".form-group label { display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500; font-size: 14px; }";
  html += ".form-group textarea { width: 100%; min-height: 150px; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 14px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; resize: vertical; background: #f8fafc; transition: all 0.3s; }";
  html += ".form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); background: #ffffff; }";
  html += ".form-group textarea::placeholder { color: #a0aec0; }";
  html += ".btn { padding: 12px 24px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; justify-content: center; }";
  html += ".btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }";
  html += ".btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }";
  html += ".btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }";
  html += ".status { margin: 15px 0; padding: 12px 16px; border-radius: 12px; text-align: center; display: none; font-weight: 500; }";
  html += ".status.success { background: #f0fff4; color: #22543d; border: 2px solid #9ae6b4; }";
  html += ".status.error { background: #fff5f5; color: #742a2a; border: 2px solid #fed7d7; }";
  html += ".status.loading { background: #ebf8ff; color: #2a4365; border: 2px solid #90cdf4; }";
  html += ".back-btn { position: fixed; top: 20px; left: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: #4a5568; font-size: 18px; transition: all 0.3s; }";
  html += ".back-btn:hover { background: rgba(255,255,255,1); transform: scale(1.05); }";
  html += ".result { margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 2px solid #e2e8f0; }";
  html += ".result h3 { margin: 0 0 12px 0; color: #2d3748; font-size: 16px; font-weight: 600; }";
  html += ".result ul { margin: 0; padding-left: 20px; }";
  html += ".result li { margin: 8px 0; color: #4a5568; }";
  html += ".examples { background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 20px; }";
  html += ".examples-title { color: #2d3748; font-size: 14px; font-weight: 600; margin-bottom: 8px; }";
  html += ".example-code { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 12px; color: #2d3748; }";
  html += "@media (max-width: 600px) { .container { margin: 10px; padding: 20px; } }";
  html += "</style>";
  html += "</head>";
  html += "<body>";
  html += "<button class='back-btn' onclick='window.location.href=\"/\"'>‚Üê</button>";
  html += "<div class='container'>";
  html += "<div class='header'>";
  html += "<div class='header-icon'>‚å®Ô∏è</div>";
  html += "<h1>G-code Control</h1>";
  html += "<div class='subtitle'>Program your robot with G-code commands</div>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<div class='card-title'>‚ÑπÔ∏è G-code Examples</div>";
  html += "<div class='examples'>";
  html += "<div class='examples-title'>Common Commands:</div>";
  html += "<div class='example-code'>";
  html += "G0 X100 Y50 Z30    ; Move to position<br>";
  html += "G1 X200 Y100 F1000 ; Linear move with speed<br>";
  html += "M3 S90             ; Open gripper to 90¬∞<br>";
  html += "M5                 ; Close gripper<br>";
  html += "G28                ; Go to home position";
  html += "</div>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<div class='card-title'>üíª G-code Input</div>";
  html += "<div id='statusMessage' class='status'></div>";
  html += "<form id='gcodeForm'>";
  html += "<div class='form-group'>";
  html += "<label for='gcode'>Enter G-code Commands:</label>";
  html += "<textarea id='gcode' name='gcode' placeholder='Enter your G-code commands here...\\nExample:\\nG0 X100 Y50 Z30\\nM3 S90\\nG1 X200 Y100 F1000\\nM5'></textarea>";
  html += "</div>";
  html += "<button type='submit' class='btn btn-primary' id='executeButton'>‚ñ∂Ô∏è Execute G-code</button>";
  html += "</form>";
  html += "</div>";
  
  html += "<div id='result' class='result' style='display:none;'>";
  html += "<h3>‚úÖ Execution Results</h3>";
  html += "<ul id='resultList'></ul>";
  html += "</div>";
  
  html += "</div>";
  
  html += "<script>";
  html += "let isExecuting = false;";
  html += "function showStatus(message, type) {";
  html += "  const statusDiv = document.getElementById('statusMessage');";
  html += "  if (!statusDiv) return;";
  html += "  statusDiv.textContent = message;";
  html += "  statusDiv.className = 'status ' + type;";
  html += "  statusDiv.style.display = 'block';";
  html += "  if (type !== 'loading') {";
  html += "    setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);";
  html += "  }";
  html += "}";
  html += "function updateUI(disabled) {";
  html += "  document.getElementById('executeButton').disabled = disabled;";
  html += "  const btn = document.getElementById('executeButton');";
  html += "  btn.innerHTML = disabled ? '‚è≥ Executing...' : '‚ñ∂Ô∏è Execute G-code';";
  html += "}";
  html += "document.getElementById('gcodeForm').addEventListener('submit', function(e) {";
  html += "  e.preventDefault();";
  html += "  if (isExecuting) return;";
  html += "  const gcode = document.getElementById('gcode').value.trim();";
  html += "  if (!gcode) {";
  html += "    showStatus('Please enter G-code commands.', 'error');";
  html += "    return;";
  html += "  }";
  html += "  isExecuting = true;";
  html += "  updateUI(true);";
  html += "  showStatus('Executing G-code commands...', 'loading');";
  html += "  fetch('/gcode', {";
  html += "    method: 'POST',";
  html += "    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },";
  html += "    body: 'gcode=' + encodeURIComponent(gcode)";
  html += "  })";
  html += "    .then(response => response.text())";
  html += "    .then(data => {";
  html += "      showStatus('G-code executed successfully!', 'success');";
  html += "      document.getElementById('result').style.display = 'block';";
  html += "      const resultList = document.getElementById('resultList');";
  html += "      resultList.innerHTML = '<li>G-code execution completed</li><li>Commands processed successfully</li>';";
  html += "      setTimeout(() => { location.reload(); }, 2000);";
  html += "    })";
  html += "    .catch(error => {";
  html += "      console.error('Error:', error);";
  html += "      showStatus('Error executing G-code. Please check your commands.', 'error');";
  html += "    })";
  html += "    .finally(() => {";
  html += "      isExecuting = false;";
  html += "      updateUI(false);";
  html += "    });";
  html += "});";
  html += "</script>";
  html += "</body></html>";
  return html;
}

String generateSetupPage() {
  String html = "<!DOCTYPE html>";
  html += "<html lang=\"en\">";
  html += "<head>";
  html += "<meta charset=\"UTF-8\">";
  html += "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">";
  html += "<title>Robot Arm - WiFi Setup</title>";
  html += getInlineIcons();
  html += "<style>";
  html += "* { margin: 0; padding: 0; box-sizing: border-box; }";
  html += "body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; min-height: 100vh; padding: 20px; }";
  html += ".container { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); max-width: 480px; margin: 0 auto; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.1); padding: 32px; animation: slideUp 0.8s ease-out; }";
  html += "@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }";
  html += ".header { text-align: center; margin-bottom: 32px; }";
  html += ".header-icon { font-size: 40px; color: #667eea; margin-bottom: 12px; }";
  html += "h1 { color: #2d3748; font-size: 24px; font-weight: 700; margin-bottom: 8px; }";
  html += ".subtitle { color: #718096; font-size: 14px; }";
  html += ".card { background: #ffffff; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }";
  html += ".card-title { color: #2d3748; font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }";
  html += ".card-title i { color: #667eea; }";
  html += ".form-group { margin-bottom: 20px; }";
  html += ".form-group label { display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500; font-size: 14px; }";
  html += ".form-group input { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; transition: all 0.3s; background: #ffffff; }";
  html += ".form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }";
  html += ".btn { padding: 12px 24px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; justify-content: center; width: 100%; }";
  html += ".btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }";
  html += ".btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }";
  html += ".back-btn { position: fixed; top: 20px; left: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: #4a5568; font-size: 18px; transition: all 0.3s; }";
  html += ".back-btn:hover { background: rgba(255,255,255,1); transform: scale(1.05); }";
  html += "@media (max-width: 600px) { .container { margin: 10px; padding: 20px; } }";
  html += "</style>";
  html += "</head>";
  html += "<body>";
  html += "<button class='back-btn' onclick='window.location.href=\"/\"'>‚Üê</button>";
  html += "<div class='container'>";
  html += "<div class='header'>";
  html += "<div class='header-icon'>üì∂</div>";
  html += "<h1>WiFi & Network Setup</h1>";
  html += "<div class='subtitle'>Configure network settings for your robot</div>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<div class='card-title'>üåê Network Configuration</div>";
  html += "<form action='/save-setup' method='POST'>";
  html += "<div class='form-group'><label for='ssid'>WiFi Network (SSID)</label><input type='text' id='ssid' name='ssid' placeholder='Enter WiFi network name'></div>";
  html += "<div class='form-group'><label for='password'>WiFi Password</label><input type='password' id='password' name='password' placeholder='Enter WiFi password'></div>";
  html += "<div class='form-group'><label for='ip'>StaticIP Address</label><input type='text' id='ip' name='ip' value='" + readStringFromEEPROM(64) + "' placeholder='192.168.1.100'></div>";
  html += "<div class='form-group'><label for='gateway'>Gateway</label><input type='text' id='gateway' name='gateway' value='" + readStringFromEEPROM(96) + "' placeholder='192.168.1.1'></div>";
  html += "<div class='form-group'><label for='subnet'>Subnet Mask</label><input type='text' id='subnet' name='subnet' value='" + readStringFromEEPROM(128) + "' placeholder='255.255.255.0'></div>";
  html += "<button type='submit' class='btn btn-primary'>üíæ Save Configuration</button>";
  html += "</form>";
  html += "</div>";
  
  html += "</div>";
  html += "</body></html>";
  return html;
}

String generateConfigPage(float theta1AngleToSteps, float theta2AngleToSteps, float phiAngleToSteps,
                         double L1, double L2, double baseHeight) {
  String html = "<!DOCTYPE html>";
  html += "<html lang=\"en\">";
  html += "<head>";
  html += "<meta charset=\"UTF-8\">";
  html += "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">";
  html += "<title>Robot Arm - Configuration</title>";
  html += getInlineIcons();
  html += "<style>";
  html += "* { margin: 0; padding: 0; box-sizing: border-box; }";
  html += "body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; min-height: 100vh; padding: 20px; }";
  html += ".container { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); max-width: 600px; margin: 0 auto; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.1); padding: 32px; animation: slideUp 0.8s ease-out; }";
  html += "@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }";
  html += ".header { text-align: center; margin-bottom: 32px; }";
  html += ".header-icon { font-size: 40px; color: #667eea; margin-bottom: 12px; }";
  html += "h1 { color: #2d3748; font-size: 24px; font-weight: 700; margin-bottom: 8px; }";
  html += ".subtitle { color: #718096; font-size: 14px; }";
  html += ".card { background: #ffffff; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }";
  html += ".card-title { color: #2d3748; font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }";
  html += ".card-title i { color: #667eea; }";
  html += ".form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }";
  html += ".form-group { margin-bottom: 20px; }";
  html += ".form-group label { display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500; font-size: 14px; }";
  html += ".form-group input { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; transition: all 0.3s; background: #ffffff; }";
  html += ".form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }";
  html += ".btn { padding: 12px 24px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; justify-content: center; width: 100%; }";
  html += ".btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }";
  html += ".btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }";
  html += ".back-btn { position: fixed; top: 20px; left: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: #4a5568; font-size: 18px; transition: all 0.3s; }";
  html += ".back-btn:hover { background: rgba(255,255,255,1); transform: scale(1.05); }";
  html += "@media (max-width: 600px) { .container { margin: 10px; padding: 20px; } .form-grid { grid-template-columns: 1fr; } }";
  html += "</style>";
  html += "</head>";
  html += "<body>";
  html += "<button class='back-btn' onclick='window.location.href=\"/\"'>‚Üê</button>";
  html += "<div class='container'>";
  html += "<div class='header'>";
  html += "<div class='header-icon'><i class='fa fa-cogs'></i></div>";
  html += "<h1>Robot Configuration</h1>";
  html += "<div class='subtitle'>Configure robot parameters and network settings</div>";
  html += "</div>";
  
  html += "<form action='/save-param' method='POST'>";
  html += "<div class='card'>";
  html += "<div class='card-title'><i class='fa fa-robot'></i> Robot Parameters</div>";
  html += "<div class='form-grid'>";
  html += "<div class='form-group'><label for='theta1AngleToSteps'>Theta1 AngleToSteps</label><input type='number' step='0.1' id='theta1AngleToSteps' name='theta1AngleToSteps' value='" + String(theta1AngleToSteps) + "'></div>";
  html += "<div class='form-group'><label for='theta2AngleToSteps'>Theta2 AngleToSteps</label><input type='number' step='0.1' id='theta2AngleToSteps' name='theta2AngleToSteps' value='" + String(theta2AngleToSteps) + "'></div>";
  html += "<div class='form-group'><label for='phiAngleToSteps'>Phi AngleToSteps</label><input type='number' step='0.1' id='phiAngleToSteps' name='phiAngleToSteps' value='" + String(phiAngleToSteps) + "'></div>";
  html += "<div class='form-group'><label for='L1'>L1 Link Length (mm)</label><input type='number' step='0.1' id='L1' name='L1' value='" + String(L1) + "'></div>";
  html += "<div class='form-group'><label for='L2'>L2 Link Length (mm)</label><input type='number' step='0.1' id='L2' name='L2' value='" + String(L2) + "'></div>";
  html += "<div class='form-group'><label for='baseHeight'>Base Height (mm)</label><input type='number' step='0.1' id='baseHeight' name='baseHeight' value='" + String(baseHeight) + "'></div>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<div class='card-title'>üåê Network Settings</div>";
  html += "<div class='form-grid'>";
  html += "<div class='form-group'><label for='ip'>StaticIP Address</label><input type='text' id='ip' name='ip' value='" + readStringFromEEPROM(64) + "' placeholder='192.168.1.100'></div>";
  html += "<div class='form-group'><label for='gateway'>Gateway</label><input type='text' id='gateway' name='gateway' value='" + readStringFromEEPROM(96) + "' placeholder='192.168.1.1'></div>";
  html += "<div class='form-group'><label for='subnet'>Subnet Mask</label><input type='text' id='subnet' name='subnet' value='" + readStringFromEEPROM(128) + "' placeholder='255.255.255.0'></div>";
  html += "</div>";
  html += "</div>";
  
  html += "<button type='submit' class='btn btn-primary'>üíæ Save All Settings</button>";
  html += "</form>";
  
  html += "</div>";
  html += "</body></html>";
  return html;
}

String generateOtaPage() {
  String html = "<!DOCTYPE html>";
  html += "<html lang=\"en\">";
  html += "<head>";
  html += "<meta charset=\"UTF-8\">";
  html += "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">";
  html += "<title>Robot Arm - Firmware Update</title>";
  html += getInlineIcons();
  html += "<style>";
  html += "* { margin: 0; padding: 0; box-sizing: border-box; }";
  html += "body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; min-height: 100vh; padding: 20px; }";
  html += ".container { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); max-width: 480px; margin: 0 auto; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.1); padding: 32px; animation: slideUp 0.8s ease-out; }";
  html += "@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }";
  html += ".header { text-align: center; margin-bottom: 32px; }";
  html += ".header-icon { font-size: 40px; color: #667eea; margin-bottom: 12px; }";
  html += "h1 { color: #2d3748; font-size: 24px; font-weight: 700; margin-bottom: 8px; }";
  html += ".subtitle { color: #718096; font-size: 14px; }";
  html += ".card { background: #ffffff; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }";
  html += ".card-title { color: #2d3748; font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }";
  html += ".card-title i { color: #667eea; }";
  html += ".upload-area { border: 2px dashed #e2e8f0; border-radius: 12px; padding: 32px; text-align: center; background: #f8fafc; transition: all 0.3s; margin-bottom: 20px; }";
  html += ".upload-area:hover { border-color: #667eea; background: #f0f4ff; }";
  html += ".upload-icon { font-size: 48px; color: #a0aec0; margin-bottom: 16px; }";
  html += ".upload-text { color: #4a5568; margin-bottom: 12px; }";
  html += ".file-input { margin: 16px 0; }";
  html += ".file-input input[type='file'] { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: #ffffff; }";
  html += ".btn { padding: 12px 24px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; justify-content: center; width: 100%; }";
  html += ".btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }";
  html += ".btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }";
  html += ".btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }";
  html += ".progress-container { margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 12px; display: none; }";
  html += ".progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-bottom: 8px; }";
  html += ".progress-fill { height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s; border-radius: 4px; }";
  html += ".progress-text { text-align: center; color: #4a5568; font-weight: 500; }";
  html += ".back-btn { position: fixed; top: 20px; left: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); color: #4a5568; font-size: 18px; transition: all 0.3s; }";
  html += ".back-btn:hover { background: rgba(255,255,255,1); transform: scale(1.05); }";
  html += ".warning { background: #fff5f5; border: 2px solid #fed7d7; border-radius: 12px; padding: 16px; margin-bottom: 20px; }";
  html += ".warning-title { color: #742a2a; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }";
  html += ".warning-text { color: #742a2a; font-size: 14px; }";
  html += "@media (max-width: 600px) { .container { margin: 10px; padding: 20px; } }";
  html += "</style>";
  html += "</head>";
  html += "<body>";
  html += "<button class='back-btn' onclick='window.location.href=\"/\"'>‚Üê</button>";
  html += "<div class='container'>";
  html += "<div class='header'>";
  html += "<div class='header-icon'>üîß</div>";
  html += "<h1>Firmware Update</h1>";
  html += "<div class='subtitle'>Upload new firmware to your robot</div>";
  html += "</div>";
  
  html += "<div class='warning'>";
  html += "<div class='warning-title'>‚ö†Ô∏è Important Warning</div>";
  html += "<div class='warning-text'>Do not power off or disconnect the robot during firmware update. This could damage your device.</div>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<div class='card-title'>üì§ Select Firmware File</div>";
  html += "<form method='POST' action='#' enctype='multipart/form-data' id='upload_form'>";
  html += "<div class='upload-area'>";
  html += "<div class='upload-icon'>‚òÅÔ∏è</div>";
  html += "<div class='upload-text'>Select firmware file (.bin)</div>";
  html += "<div class='file-input'>";
  html += "<input type='file' name='update' accept='.bin' required>";
  html += "</div>";
  html += "</div>";
  html += "<button type='submit' class='btn btn-primary' id='updateBtn'>üì§ Upload Firmware</button>";
  html += "</form>";
  
  html += "<div class='progress-container' id='progressContainer'>";
  html += "<div class='progress-bar'>";
  html += "<div class='progress-fill' id='progressFill'></div>";
  html += "</div>";
  html += "<div class='progress-text' id='progressText'>Upload Progress: 0%</div>";
  html += "</div>";
  html += "</div>";
  
  html += "</div>";
  
  html += "<script>";
  html += "$('form').submit(function(e){";
  html += "e.preventDefault();";
  html += "var form = document.getElementById('upload_form');";
  html += "var data = new FormData(form);";
  html += "document.getElementById('progressContainer').style.display = 'block';";
  html += "var btn = document.getElementById('updateBtn');";
  html += "btn.disabled = true;";
  html += "btn.innerHTML = '‚è≥ Uploading...';";
  html += "var xhr = new XMLHttpRequest();";
  html += "xhr.upload.addEventListener('progress', function(evt) {";
  html += "if (evt.lengthComputable) {";
  html += "var per = Math.round((evt.loaded / evt.total) * 100);";
  html += "document.getElementById('progressFill').style.width = per + '%';";
  html += "var progressText = document.getElementById('progressText');";
  html += "if (progressText) progressText.innerHTML = 'Upload Progress: ' + per + '%';";
  html += "}";
  html += "}, false);";
  html += "xhr.onload = function() {";
  html += "if (xhr.status === 200) {";
  html += "var progressText = document.getElementById('progressText');";
  html += "if (progressText) progressText.innerHTML = 'Upload completed! Device will restart...';";
  html += "setTimeout(function() { alert('Firmware update completed successfully!'); }, 2000);";
  html += "} else {";
  html += "var progressText = document.getElementById('progressText');";
  html += "if (progressText) progressText.innerHTML = 'Upload failed. Please try again.';";
  html += "btn.disabled = false;";
  html += "btn.innerHTML = 'üì§ Upload Firmware';";
  html += "}";
  html += "};";
  html += "xhr.onerror = function() {";
  html += "var progressText = document.getElementById('progressText');";
  html += "if (progressText) progressText.innerHTML = 'Upload failed. Please try again.';";
  html += "btn.disabled = false;";
  html += "btn.innerHTML = 'üì§ Upload Firmware';";
  html += "};";
  html += "xhr.open('POST', '/update');";
  html += "xhr.send(data);";
  html += "});";
  html += "</script>";
  html += "</body></html>";
  return html;
}

String generateApiDocPage() {
  String html = "<!DOCTYPE html>";
  html += "<html lang=\"en\">";
  html += "<head>";
  html += "<meta charset=\"UTF-8\">";
  html += "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">";
  html += "<title>Robot Arm API Documentation</title>";
  html += "<style>";
  html += "body { background: #f8fafc; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; color: #2d3748; }";
  html += ".container { max-width: 1200px; margin: 0 auto; }";
  html += "h1 { color: #1a202c; border-bottom: 3px solid #4299e1; padding-bottom: 10px; }";
  html += "h2 { color: #2d3748; margin-top: 30px; padding: 10px; background: #edf2f7; border-left: 4px solid #4299e1; }";
  html += "h3 { color: #4a5568; margin-top: 25px; }";
  html += ".endpoint { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 20px 0; padding: 20px; }";
  html += ".method { display: inline-block; padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; margin-right: 10px; }";
  html += ".get { background: #38a169; } .post { background: #3182ce; } .put { background: #d69e2e; } .delete { background: #e53e3e; }";
  html += ".url { font-family: 'Courier New', monospace; background: #f7fafc; padding: 8px; border-radius: 4px; margin: 10px 0; }";
  html += ".params { background: #f7fafc; padding: 15px; border-radius: 4px; margin: 10px 0; }";
  html += ".param { margin: 8px 0; }";
  html += ".param-name { font-weight: bold; color: #2b6cb0; }";
  html += ".param-type { color: #805ad5; font-style: italic; }";
  html += ".required { color: #e53e3e; font-size: 12px; }";
  html += ".example { background: #1a202c; color: #e2e8f0; padding: 15px; border-radius: 4px; margin: 10px 0; overflow-x: auto; }";
  html += ".response { background: #f0fff4; border: 1px solid #9ae6b4; padding: 15px; border-radius: 4px; margin: 10px 0; }";
  html += "code { background: #edf2f7; padding: 2px 4px; border-radius: 3px; font-family: 'Courier New', monospace; }";
  html += ".nav { background: #4299e1; color: white; padding: 10px 0; margin: -20px -20px 20px -20px; }";
  html += ".nav a { color: white; text-decoration: none; margin: 0 15px; }";
  html += ".nav a:hover { text-decoration: underline; }";
  html += ".test-button { background: #48bb78; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }";
  html += ".test-button:hover { background: #38a169; }";
  html += ".test-result { background: #f7fafc; border: 1px solid #cbd5e0; padding: 10px; border-radius: 4px; margin: 10px 0; white-space: pre-wrap; }";
  html += "</style>";
  html += "</head>";
  html += "<body>";
  html += "<div class='nav'>";
  html += "<div class='container'>";
  html += "<strong>Robot Arm API</strong>";
  html += "<a href='#overview'>Overview</a>";
  html += "<a href='#authentication'>Authentication</a>";
  html += "<a href='#endpoints'>Endpoints</a>";
  html += "<a href='#examples'>Examples</a>";
  html += "<a href='/'>‚Üê Back to Control Panel</a>";
  html += "</div></div>";
  html += "<div class='container'>";
  
  html += "<h1 id='overview'>Robot Arm API Documentation</h1>";
  html += "<p>This API allows you to control the robot arm programmatically. All endpoints return JSON responses with status information.</p>";
  
  html += "<h2 id='authentication'>Base URL & Authentication</h2>";
  html += "<div class='endpoint'>";
  html += "<div class='url'>Base URL: http://" + WiFi.localIP().toString() + "/api/</div>";
  html += "<p><strong>Authentication:</strong> No authentication required for this version.</p>";
  html += "<p><strong>Content-Type:</strong> application/json (for POST requests)</p>";
  html += "<p><strong>CORS:</strong> Enabled for all origins (*)</p>";
  html += "</div>";

  html += "<h2>Response Format</h2>";
  html += "<div class='endpoint'>";
  html += "<p>All API responses follow this standard format:</p>";
  html += "<div class='example'>{";
  html += "  \"status\": \"success|error\",";
  html += "  \"message\": \"Human readable message\",";
  html += "  \"data\": { /* Response data */ },";
  html += "  \"timestamp\": 1234567890";
  html += "}</div>";
  html += "</div>";

  html += "<h2 id='endpoints'>API Endpoints</h2>";

  // Move API
  html += "<div class='endpoint'>";
  html += "<h3><span class='method post'>POST</span> /api/move</h3>";
  html += "<p>Move robot arm to specific X, Y, Z coordinates.</p>";
  html += "<div class='params'>";
  html += "<div class='param'><span class='param-name'>x</span> <span class='param-type'>(integer)</span> <span class='required'>required</span> - X coordinate</div>";
  html += "<div class='param'><span class='param-name'>y</span> <span class='param-type'>(integer)</span> <span class='required'>required</span> - Y coordinate</div>";
  html += "<div class='param'><span class='param-name'>z</span> <span class='param-type'>(integer)</span> <span class='required'>required</span> - Z coordinate</div>";
  html += "<div class='param'><span class='param-name'>speed</span> <span class='param-type'>(integer)</span> - Movement speed (default: current speed)</div>";
  html += "<div class='param'><span class='param-name'>acceleration</span> <span class='param-type'>(integer)</span> - Movement acceleration (default: current acceleration)</div>";
  html += "</div>";
  html += "<div class='example'>curl -X POST http://" + WiFi.localIP().toString() + "/api/move \\";
  html += "  -d \"x=300&y=210&z=50&speed=100&acceleration=500\"</div>";
  html += "<button class='test-button' onclick='testMove()'>Test Move API</button>";
  html += "<div id='move-result' class='test-result' style='display:none;'></div>";
  html += "</div>";

  // Joint API
  html += "<div class='endpoint'>";
  html += "<h3><span class='method post'>POST</span> /api/joint</h3>";
  html += "<p>Move robot joints to specific angles.</p>";
  html += "<div class='params'>";
  html += "<div class='param'><span class='param-name'>theta1</span> <span class='param-type'>(integer)</span> <span class='required'>required</span> - Joint 1 angle (degrees)</div>";
  html += "<div class='param'><span class='param-name'>theta2</span> <span class='param-type'>(integer)</span> <span class='required'>required</span> - Joint 2 angle (degrees)</div>";
  html += "<div class='param'><span class='param-name'>theta3</span> <span class='param-type'>(integer)</span> <span class='required'>required</span> - Joint 3 angle (degrees)</div>";
  html += "<div class='param'><span class='param-name'>speed</span> <span class='param-type'>(integer)</span> - Movement speed</div>";
  html += "<div class='param'><span class='param-name'>acceleration</span> <span class='param-type'>(integer)</span> - Movement acceleration</div>";
  html += "</div>";
  html += "<div class='example'>curl -X POST http://" + WiFi.localIP().toString() + "/api/joint \\";
  html += "  -d \"theta1=45&theta2=30&theta3=60\"</div>";
  html += "<button class='test-button' onclick='testJoint()'>Test Joint API</button>";
  html += "<div id='joint-result' class='test-result' style='display:none;'></div>";
  html += "</div>";

  // Gripper API
  html += "<div class='endpoint'>";
  html += "<h3><span class='method post'>POST</span> /api/gripper</h3>";
  html += "<p>Control gripper position.</p>";
  html += "<div class='params'>";
  html += "<div class='param'><span class='param-name'>position</span> <span class='param-type'>(integer)</span> <span class='required'>required</span> - Gripper position (0-180)</div>";
  html += "</div>";
  html += "<div class='example'>curl -X POST http://" + WiFi.localIP().toString() + "/api/gripper \\";
  html += "  -d \"position=90\"</div>";
  html += "<button class='test-button' onclick='testGripper()'>Test Gripper API</button>";
  html += "<div id='gripper-result' class='test-result' style='display:none;'></div>";
  html += "</div>";

  // Status API
  html += "<div class='endpoint'>";
  html += "<h3><span class='method get'>GET</span> /api/status</h3>";
  html += "<p>Get current robot status and position.</p>";
  html += "<div class='example'>curl -X GET http://" + WiFi.localIP().toString() + "/api/status</div>";
  html += "<button class='test-button' onclick='testStatus()'>Test Status API</button>";
  html += "<div id='status-result' class='test-result' style='display:none;'></div>";
  html += "</div>";

  // G-code API
  html += "<div class='endpoint'>";
  html += "<h3><span class='method post'>POST</span> /api/gcode</h3>";
  html += "<p>Execute G-code commands.</p>";
  html += "<div class='params'>";
  html += "<div class='param'><span class='param-name'>gcode</span> <span class='param-type'>(string)</span> <span class='required'>required</span> - G-code commands (multiline supported)</div>";
  html += "</div>";
  html += "<div class='example'>curl -X POST http://" + WiFi.localIP().toString() + "/api/gcode \\";
  html += "  -d \"gcode=X100Y150Z200\\nGPON\\nDELAY1000\\nGPOFF\"</div>";
  html += "<button class='test-button' onclick='testGcode()'>Test G-code API</button>";
  html += "<div id='gcode-result' class='test-result' style='display:none;'></div>";
  html += "</div>";

  // Home API
  html += "<div class='endpoint'>";
  html += "<h3><span class='method post'>POST</span> /api/home</h3>";
  html += "<p>Move robot to home position.</p>";
  html += "<div class='example'>curl -X POST http://" + WiFi.localIP().toString() + "/api/home</div>";
  html += "<button class='test-button' onclick='testHome()'>Test Home API</button>";
  html += "<div id='home-result' class='test-result' style='display:none;'></div>";
  html += "</div>";

  // Zero API
  html += "<div class='endpoint'>";
  html += "<h3><span class='method post'>POST</span> /api/zero</h3>";
  html += "<p>Calibrate robot (move to zero position with limit switches).</p>";
  html += "<div class='example'>curl -X POST http://" + WiFi.localIP().toString() + "/api/zero</div>";
  html += "<button class='test-button' onclick='testZero()'>Test Zero API</button>";
  html += "<div id='zero-result' class='test-result' style='display:none;'></div>";
  html += "</div>";

  html += "<h2 id='examples'>Programming Examples</h2>";
  
  // JavaScript example
  html += "<div class='endpoint'>";
  html += "<h3>JavaScript (Fetch API)</h3>";
  html += "<div class='example'>// Move robot to position";
  html += "fetch('http://" + WiFi.localIP().toString() + "/api/move', {";
  html += "  method: 'POST',";
  html += "  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },";
  html += "  body: 'x=100&y=150&z=200'";
  html += "})";
  html += ".then(response => response.json())";
  html += ".then(data => console.log(data));";
  html += "";
  html += "// Get robot status";
  html += "fetch('http://" + WiFi.localIP().toString() + "/api/status')";
  html += ".then(response => response.json())";
  html += ".then(data => console.log(data));</div>";
  html += "</div>";

  // Python example
  html += "<div class='endpoint'>";
  html += "<h3>Python (requests)</h3>";
  html += "<div class='example'>import requests";
  html += "";
  html += "# Move robot";
  html += "response = requests.post('http://" + WiFi.localIP().toString() + "/api/move', ";
  html += "                       data={'x': 100, 'y': 150, 'z': 200})";
  html += "print(response.json())";
  html += "";
  html += "# Get status";
  html += "response = requests.get('http://" + WiFi.localIP().toString() + "/api/status')";
  html += "print(response.json())</div>";
  html += "</div>";

  // Error Codes
  html += "<h2>Error Codes</h2>";
  html += "<div class='endpoint'>";
  html += "<div class='response'>";
  html += "<strong>200</strong> - Success<br>";
  html += "<strong>400</strong> - Bad Request (missing or invalid parameters)<br>";
  html += "<strong>405</strong> - Method Not Allowed<br>";
  html += "<strong>500</strong> - Internal Server Error";
  html += "</div>";
  html += "</div>";

  html += "</div>";

  // JavaScript for testing
  html += "<script>";
  html += "function showResult(id, data) {";
  html += "  const elem = document.getElementById(id);";
  html += "  if (!elem) return;";
  html += "  elem.textContent = JSON.stringify(data, null, 2);";
  html += "  elem.style.display = 'block';";
  html += "}";
  html += "function testMove() {";
  html += "  fetch('/api/move', {";
  html += "    method: 'POST',";
  html += "    headers: {'Content-Type': 'application/x-www-form-urlencoded'},";
  html += "    body: 'x=300&y=210&z=200'";
  html += "  }).then(r => r.json()).then(data => showResult('move-result', data));";
  html += "}";
  html += "function testJoint() {";
  html += "  fetch('/api/joint', {";
  html += "    method: 'POST',";
  html += "    headers: {'Content-Type': 'application/x-www-form-urlencoded'},";
  html += "    body: 'theta1=10&theta2=20&theta3=30'";
  html += "  }).then(r => r.json()).then(data => showResult('joint-result', data));";
  html += "}";
  html += "function testGripper() {";
  html += "  fetch('/api/gripper', {";
  html += "    method: 'POST',";
  html += "    headers: {'Content-Type': 'application/x-www-form-urlencoded'},";
  html += "    body: 'position=90'";
  html += "  }).then(r => r.json()).then(data => showResult('gripper-result', data));";
  html += "}";
  html += "function testStatus() {";
  html += "  fetch('/api/status').then(r => r.json()).then(data => showResult('status-result', data));";
  html += "}";
  html += "function testGcode() {";
  html += "  fetch('/api/gcode', {";
  html += "    method: 'POST',";
  html += "    headers: {'Content-Type': 'application/x-www-form-urlencoded'},";
  html += "    body: 'gcode=X50Y50Z50'";
  html += "  }).then(r => r.json()).then(data => showResult('gcode-result', data));";
  html += "}";
  html += "function testHome() {";
  html += "  fetch('/api/home', {method: 'POST'}).then(r => r.json()).then(data => showResult('home-result', data));";
  html += "}";
  html += "function testZero() {";
  html += "  fetch('/api/zero', {method: 'POST'}).then(r => r.json()).then(data => showResult('zero-result', data));";
  html += "}";
  html += "</script>";
  html += "</body></html>";
  
  return html;
}
